{% extends "layout.html" %}

{% block head_scripts %}
    <script type="importmap">
    {
        "imports": {
            "three": "{{ url_for('static', filename='js/three.module.js') }}",
            "OrbitControls": "{{ url_for('static', filename='js/OrbitControls.js') }}",
            "BVHLoader": "{{ url_for('static', filename='js/BVHLoader.js') }}"
        }
    }
    </script>
    <style>
        * {
            box-sizing: border-box;
        }
        .viewer h3 {
            margin-bottom: 5px; /* Add some space below the title */
            margin-top: 0;
        }
        .viewer-canvas {
            position: relative;
        }
        .reset-camera-btn {
            position: absolute;
            top: 0px;
            left: 15px;
            z-index: 10;
            cursor: pointer;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 18px;
            line-height: 30px;
            text-align: center;
            padding: 0;
        }
        .reset-camera-btn:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
{% endblock %}

{% block content %}

    <div class="viewer-container" data-mod-no="{{ mod_no }}">
        <div class="viewer">
            <h3>Motion Left</h3>
            <div id="viewer-left" class="viewer-canvas" data-bvh-file="{{ url_for('static', filename='bvh/' + motion_left) }}">
                <button class="reset-camera-btn">&#x21BB;</button>
            </div>
        </div>
        <div class="viewer">
            <h3>Motion Right</h3>
            <div id="viewer-right" class="viewer-canvas" data-bvh-file="{{ url_for('static', filename='bvh/' + motion_right) }}">
                <button class="reset-camera-btn">&#x21BB;</button>
            </div>
        </div>
    </div>

    <form method="post" action="{{ url_for('run_trial', trial_num=trial_num) }}">
        <h3>Questionnaire</h3>
        <p>For each question, please choose which motion better represents the described personality trait or emotion.</p>

        {% for i in range(1, 20) %}
        <div class="question">
            <p>{{ i }}. {{ questions[i-1] }}</p>
            {% if i <= 17 %}
            <div class="comparison-buttons">
                <input id="q{{ i }}_left" type="radio" name="q{{ i }}" value="Left">
                <label for="q{{ i }}_left">Left</label>

                <input id="q{{ i }}_equal" type="radio" name="q{{ i }}" value="Equal">
                <label for="q{{ i }}_equal">Equal</label>

                <input id="q{{ i }}_right" type="radio" name="q{{ i }}" value="Right">
                <label for="q{{ i }}_right">Right</label>
            </div>
            {% else %}
            <div class="rating-buttons">
                <input id="q{{ i }}_1" type="radio" name="q{{ i }}" value="1">
                <label for="q{{ i }}_1">1</label>

                <input id="q{{ i }}_2" type="radio" name="q{{ i }}" value="2">
                <label for="q{{ i }}_2">2</label>

                <input id="q{{ i }}_3" type="radio" name="q{{ i }}" value="3">
                <label for="q{{ i }}_3">3</label>

                <input id="q{{ i }}_4" type="radio" name="q{{ i }}" value="4">
                <label for="q{{ i }}_4">4</label>

                <input id="q{{ i }}_5" type="radio" name="q{{ i }}" value="5">
                <label for="q{{ i }}_5">5</label>
            </div>
            {% endif %}
        </div>
        <hr>
        {% endfor %}

        <!-- <button type="button" id="random-answers-btn" style="background-color: #ffc107; color: #333; margin-top: 10px;">Random Answers (TESTING)</button> -->
                <div id="error-message" style="color: red; margin-top: 10px; display: none;"></div>
        <button type="submit">Submit and Continue to Next Trial</button>
    </form>

    <script type="module" src="{{ url_for('static', filename='js/visualization.js') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            const errorMessage = document.getElementById('error-message');

            form.addEventListener('submit', function(event) {
                let allAnswered = true;
                for (let i = 1; i <= 19; i++) {
                    const question = document.querySelector(`input[name="q${i}"]:checked`);
                    if (!question) {
                        allAnswered = false;
                        break;
                    }
                }

                if (!allAnswered) {
                    event.preventDefault();
                    errorMessage.textContent = 'Please answer all questions before submitting.';
                    errorMessage.style.display = 'block';
                } else {
                    errorMessage.style.display = 'none';
                }
            });

            const randomAnswersBtn = document.getElementById('random-answers-btn');
            if (randomAnswersBtn) {
                randomAnswersBtn.addEventListener('click', function() {
                    for (let i = 1; i <= 19; i++) {
                        if (i <= 17) {
                            const options = ['Left', 'Equal', 'Right'];
                            const randomChoice = options[Math.floor(Math.random() * options.length)];
                            
                            const radioBtn = document.getElementById(`q${i}_${randomChoice.toLowerCase()}`);
                            if (radioBtn) {
                                radioBtn.checked = true;
                                radioBtn.dispatchEvent(new Event('change')); // Trigger change event for styling
                            }
                        } else {
                            const randomRating = Math.floor(Math.random() * 5) + 1;
                            
                            const radioBtn = document.getElementById(`q${i}_${randomRating}`);
                            if (radioBtn) {
                                radioBtn.checked = true;
                                radioBtn.dispatchEvent(new Event('change')); // Trigger change event for styling
                            }
                        }
                    }
                });
            }
        });
    </script>
{% endblock %}