{% extends "layout.html" %}

{% block head_scripts %}
    <script type="importmap">
    {
        "imports": {
            "three": "{{ url_for('static', filename='js/three.module.js') }}",
            "OrbitControls": "{{ url_for('static', filename='js/OrbitControls.js') }}",
            "BVHLoader": "{{ url_for('static', filename='js/BVHLoader.js') }}"
        }
    }
    </script>
    <style>
        * {
            box-sizing: border-box;
        }
        .viewer h4 {
            margin-bottom: 5px;
            margin-top: 0;
        }
        .viewer-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding: 0 20px;
        }
        .viewer {
            display: flex;
            flex-direction: column;
        }
        .viewer h3 {
            margin-bottom: 5px;
            margin-top: 0;
        }
        .viewer-canvas {
            position: relative;
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .reset-camera-btn {
            position: absolute;
            top: 0px;
            left: 15px;
            z-index: 10;
            cursor: pointer;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 18px;
            line-height: 30px;
            text-align: center;
            padding: 0;
        }
        .reset-camera-btn:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
{% endblock %}

{% block content %}
<h2>BVH Motion Pairs by Category</h2>

<div class="viewer-container">
    <div class="viewer">
        <h3>Motion Left</h3>
        <div id="viewer-left" class="viewer-canvas">
            <button class="reset-camera-btn">&#x21BB;</button>
        </div>
    </div>
    <div class="viewer">
        <h3>Motion Right</h3>
        <div id="viewer-right" class="viewer-canvas">
            <button class="reset-camera-btn">&#x21BB;</button>
        </div>
    </div>
</div>

<div class="bvh-pairs-container">
    {% for category in trial_categories %}
    <div class="category-section">
        <h3>Category {{ loop.index }}</h3>
        <div class="pairs-grid">
            {% for pair in category %}
            <div class="pair-item clickable-pair" 
                 data-left-file="{{ url_for('static', filename='bvh/' + pair[0]) }}" 
                 data-right-file="{{ url_for('static', filename='bvh/' + pair[1]) }}"
                 data-pair-index="{{ loop.index0 }}"
                 data-left-name="{{ pair[0] }}"
                 data-right-name="{{ pair[1] }}">
                <div class="pair-header">Pair {{ loop.index }} - {{ pair[0] }} vs {{ pair[1] }}</div>
                <div class="motion-pair">
                    <div class="motion-item">
                        <strong>Left:</strong> {{ pair[0] }}
                    </div>
                    <div class="motion-item">
                        <strong>Right:</strong> {{ pair[1] }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<style>
.bvh-pairs-container {
    padding: 20px;
}

.category-section {
    margin-bottom: 30px;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    background-color: #f9f9f9;
}

.category-section h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}

.pairs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
}

.pair-item {
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 15px;
}

.clickable-pair {
    cursor: pointer;
    transition: all 0.2s ease;
}

.clickable-pair:hover {
    background-color: #f0f8ff;
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.clickable-pair.active {
    background-color: #e3f2fd;
    border-color: #007bff;
    border-width: 2px;
}

.pair-header {
    font-weight: bold;
    margin-bottom: 10px;
    color: #555;
}

.motion-pair {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.viewer {
    display: flex;
    flex-direction: column;
}

.motion-item {
    padding: 8px;
    background-color: #f8f9fa;
    border-radius: 4px;
    font-family: monospace;
}

.motion-item strong {
    color: #007bff;
}
</style>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'OrbitControls';
import { BVHLoader } from 'BVHLoader';

let leftViewer = null;
let rightViewer = null;
let animationMixers = [];
const clock = new THREE.Clock();

const BONE_THICKNESS = 0.01;
const JOINT_SIZE = 0.02;

const boneMaterial = new THREE.MeshStandardMaterial({
    color: 0x444444,
    roughness: 0.5,
    metalness: 0.2
});

const jointMaterial = new THREE.MeshStandardMaterial({
    color: 0x007bff,
    roughness: 0.4,
    metalness: 0.1
});

function createMeshesForSkeleton(bone) {
    const jointSphere = new THREE.SphereGeometry(JOINT_SIZE, 16, 16);
    const jointMesh = new THREE.Mesh(jointSphere, jointMaterial);
    bone.add(jointMesh);

    bone.children.forEach((child) => {
        if (child.isBone) {
            const boneVector = child.position;
            const boneLength = boneVector.length();

            if (boneLength > 0.001) {
                const boneCylinder = new THREE.CylinderGeometry(BONE_THICKNESS, BONE_THICKNESS, boneLength, 8);
                const boneMesh = new THREE.Mesh(boneCylinder, boneMaterial);
                boneMesh.position.copy(boneVector).multiplyScalar(0.5);

                const startVec = new THREE.Vector3(0, 1, 0);
                const endVec = boneVector.clone().normalize();
                
                const quaternion = new THREE.Quaternion();
                quaternion.setFromUnitVectors(startVec, endVec);
                boneMesh.quaternion.copy(quaternion);

                bone.add(boneMesh);
            }
            
            createMeshesForSkeleton(child);
        }
    });
}

function clearViewer(viewer) {
    if (!viewer) return;
    
    // Remove all children except the reset button
    const canvas = viewer.container;
    const resetBtn = canvas.querySelector('.reset-camera-btn');
    
    // Clear the canvas but keep the reset button
    while (canvas.firstChild && canvas.firstChild !== resetBtn) {
        canvas.removeChild(canvas.firstChild);
    }
    if (resetBtn && canvas.children.length > 1) {
        canvas.innerHTML = '';
        canvas.appendChild(resetBtn);
    }
    
    // Clear the scene objects
    if (viewer.scene) {
        viewer.scene.clear();
    }
}

function setupViewer(container, pairIndex) {
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xeeeeee);
    
    const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 1, 2000);
    
    let cameraPos = new THREE.Vector3(0, 150, 400);
    let cameraTarget = new THREE.Vector3(0, 75, 0);

    // Set camera position based on pair index
    switch (pairIndex) {
        case 0:
            cameraPos.set(-125, 150, 350);
            cameraTarget.set(-50, 75, 50);
            break;
        case 1:
            cameraPos.set(20, 130, 150);
            break;
        case 2:
            cameraPos.set(150, 150, 50);
            break;
        case 3:
            cameraPos.set(20, 130, 150);
            break;
        default:
            break;
    }
    camera.position.copy(cameraPos);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);
    
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.target.copy(cameraTarget);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    const resetButton = container.querySelector('.reset-camera-btn');
    if (resetButton) {
        resetButton.addEventListener('click', (e) => {
            e.stopPropagation();
            camera.position.copy(cameraPos);
            controls.target.copy(cameraTarget);
        });
    }

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
    directionalLight.position.set(0, 1, 0.5).normalize();
    scene.add(directionalLight);
    
    const gridHelper = new THREE.GridHelper(800, 20);
    scene.add(gridHelper);

    return {
        container,
        scene,
        camera,
        renderer,
        controls,
        initialCameraPos: cameraPos.clone(),
        initialCameraTarget: cameraTarget.clone()
    };
}

function loadBVH(viewer, bvhFile, callback) {
    if (!viewer || !bvhFile) return;
    
    const loader = new BVHLoader();
    loader.load(bvhFile, function (result) {
        const skeletonRoot = result.skeleton.bones[0];
        createMeshesForSkeleton(skeletonRoot);

        const characterContainer = new THREE.Group();
        characterContainer.add(skeletonRoot);

        characterContainer.updateMatrixWorld(true); 
        const box = new THREE.Box3().setFromObject(characterContainer);
        const size = new THREE.Vector3();
        box.getSize(size);
        
        if (size.y > 0) {
            const desiredHeight = 150;
            const scaleFactor = desiredHeight / size.y;
            characterContainer.scale.set(scaleFactor, scaleFactor, scaleFactor);
            
            const postScaleBox = new THREE.Box3().setFromObject(characterContainer);
            const postScaleCenter = new THREE.Vector3();
            postScaleBox.getCenter(postScaleCenter);
            characterContainer.position.sub(postScaleCenter);
        }

        viewer.scene.add(characterContainer);

        const mixer = new THREE.AnimationMixer(characterContainer);
        mixer.clipAction(result.clip).setEffectiveWeight(1.0).play();
        animationMixers.push(mixer);
        
        if (callback) callback();
    });
}

function loadPair(leftFile, rightFile, leftName, rightName, pairIndex) {
    // Clear existing mixers
    animationMixers = [];
    
    // Clear existing viewers
    clearViewer(leftViewer);
    clearViewer(rightViewer);
    
    // Update titles
    document.querySelector('.viewer h3').textContent = leftName;
    document.querySelectorAll('.viewer h3')[1].textContent = rightName;
    
    // Setup new viewers
    leftViewer = setupViewer(document.getElementById('viewer-left'), pairIndex);
    rightViewer = setupViewer(document.getElementById('viewer-right'), pairIndex);
    
    // Load BVH files
    loadBVH(leftViewer, leftFile);
    loadBVH(rightViewer, rightFile);
}

function animate() {
    requestAnimationFrame(animate);
    const delta = clock.getDelta();

    if (animationMixers.length > 0) {
        animationMixers.forEach(mixer => mixer.update(delta));
    }
    
    if (leftViewer) {
        leftViewer.controls.update();
        leftViewer.renderer.render(leftViewer.scene, leftViewer.camera);
    }
    
    if (rightViewer) {
        rightViewer.controls.update();
        rightViewer.renderer.render(rightViewer.scene, rightViewer.camera);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers to pairs
    const pairs = document.querySelectorAll('.clickable-pair');
    pairs.forEach(pair => {
        pair.addEventListener('click', function() {
            // Remove active class from all pairs
            pairs.forEach(p => p.classList.remove('active'));
            // Add active class to clicked pair
            this.classList.add('active');
            
            // Load the pair
            const leftFile = this.dataset.leftFile;
            const rightFile = this.dataset.rightFile;
            const leftName = this.dataset.leftName;
            const rightName = this.dataset.rightName;
            const pairIndex = parseInt(this.dataset.pairIndex, 10);
            
            loadPair(leftFile, rightFile, leftName, rightName, pairIndex);
        });
    });
    
    // Start animation loop
    animate();
    
    // Load first pair by default
    if (pairs.length > 0) {
        pairs[0].click();
    }
});
</script>
{% endblock %}